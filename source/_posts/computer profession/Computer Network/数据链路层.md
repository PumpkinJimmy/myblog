---
title: 数据链路层
tags:
  - 专业课
abbrlink: c8c4683d
date: 2021-06-09 10:32:02
updated: 2021-06-09 10:32:02
---
## 数据链路层

提供在**直连网络**上节点之间的通信服务

四个主要功能：
- framing 形成帧
  - 在header中包含校验码、地址、和SAP（指名帧的上层协议）
- error detect 差错检验、纠错
- error control 发现丢包、重复、错序、溢出，提供流量控制
  - 注：这些特性用于提供可靠传输服务，但并不是所有的链路层协议都提供可靠传输服务的，所有这些功能不一定有（互联网络中的可靠传输服务由TCP提供，毕竟IP协议是不可靠传输协议）
- medium access control 介值访问控制
  - 用于处理多路访问网络（比如以太网）中的碰撞问题

### Error Detect
- Parity 奇偶校验码
  - 保证传输比特和校验位中1的个数为偶数/奇数（偶校验/）
  - 可以将原始的包数据排列成二维矩阵，然后采用二维的奇偶校验码即可实现检错和一位纠错
  - 可以拓展为*海明码*
- CheckSum 检验和
  - 利用加法器，将传输比特流分段相加再**取反得到校验和**
  - 常见的分段长度是16bit
  - **若加法过程中的产生的超过16bit的进位，则需要扔掉这个进位，然后+1**
  - 传输比特+校验和得到全1码
  - 由于依赖加法，且是弱校验，一般不用于链路层，而是用于网络层和传输层

- CRC 循环冗余校验
  - 利用*生成多项式*和*模2除法*实现
  - 硬件实现简单高效
  - 检错率很高

- CRC算法概述：

  1. 将生成多项式编码为二进制
  2. 根据生成多项式的二进制编码位数n，**在原数据的后面加上n-1个0**。（这样做的目的其实是方便直接将后续除出来的余数加到数据末尾，而余数位数至多是n-1）
  3. 对加0之后的数据进行模2除法：所谓模2除法可以当作常规的竖式除法，只不过“减”的时候用的是按位异或
  4. 将上面得到的余数拼接到原数据最后
  
  以上步骤使得接受方收到数据后使用相同的生成多项式做模2除法的时候，若数据没有差错，则

### Reliable Data Transfer (Link ver.)
需要分类讨论：点到点和多路访问网络。因为点到点网络的情形相对简单：不会原生出现重复、错序和碰撞，主要会发生丢包错误

点到点：
- 接收方使用序号来发现中间的丢包（由于点到点网络不会错序到达，所有中间确实的编号必然是丢了）
- 接收方收到的包检验出错（且无法纠错），则丢弃该包，相当于该包丢失了
- 发送方等待接收方的*确认帧*，若某一个包没有确认，则认为该包丢失了，需要*重传*
- 由于接收方无法检出所有的丢包（比如序号最后的连续若干个包丢失），所以不能简单地等待接收方对所有发出的包进行确认
- 正确的做法是为每个发送的帧设置*超时计时器*，一旦超时视为丢包，进行**超时重传**
- ARQ：自动重传
  - 两种策略：停止等待协议，连续确认协议
  - 停止等待协议
    - 每次发送一帧，然后等待确认，发送成功收到确认才发送下一帧，否则重传
    - 较简单，但效率非常低，因为必须等待确认才能发送下一帧（尤其是在传播时延较大的信道）
  - 可能出现的问题&解决方案
    - 帧丢失/帧校验出错
      
      发送方超时重传，接收方等待重传
  
    - 确认帧丢失
      
      发送方超时重传，接收方收到重复帧（丢弃重复），发出重复确认
  
    - 帧迟到/确认帧迟到
      
      发送方超时重传，接收方收到重复帧（丢弃重复），发出重复确认（丢弃重复），发送方收到重复确认
- 连续ARQ

  连续ARQ是指可以连续发送多个帧，不必等待确认

  - 滑动窗口协议
    - 发送窗口：通过划定发送方连续传输的最大边界来实现流量控制
    - 当发送窗口中的帧得到确认时可以将窗口右移，表示后续的帧可以继续发送了
    - 一般采用*累计确认*的方法，即收到确认号n表示序号n及其之前的全部帧都已收到
  
  若第n帧丢失，但n+1帧开始正常收到（也即*错序到达*），有两种策略：

  - Go Back N

    第n帧丢失，则从第n帧开始重传（尽管n+1帧以后的已经收到了），然后丢弃重复收到的帧

  - Selective Repeat

    增加否定性确认确认帧（NAK），表示n之前的全部帧都已收到，但第n帧丢失了。

    发现这种丢失时，接收方暂存错序到达的帧，并发送NAK

    在这种策略下，超时时间将适当增大（比如2RTT），只重传丢失的帧，并最终在收到适合的累积确认ACK后避免重传n+1开始错序到达的帧

    在信道较差的情况下，这种策略会有负面影响（超时时间增大，重传延迟）

    为了暂存错序到达的帧，接收方需要接收窗口

    注意，在该策略下接收窗口大小<=发送窗口
  
  改进滑动窗口：
  - SACK 选择确认：选择错序到达的帧进行确认，减少重传
  - Delay ACK 延迟确认：在接收到一帧后不立即发确认，等一段时间再发确认。由于基于累计确认机制，可以少发一些ACK
  - 捎带确认。由于是全双工通信，在接收方发数据的同时捎带上ACK

### PPP
PPP = Point-to-Point Protocol

PPP协议是一种用于**点到点网络**的数据链路层协议。

PPP提供的是**不可靠传输服务**

PPP数据帧
```
  标志 地址 控制 协议 数据 校验码 标志
```
- 标志规定是0x7E
- 地址固定为0xFF, 控制固定为0x03


透明传输问题：
- 作为链路层协议，PPP帧的定界依赖帧开头和结尾的**0x7E标志**。但是SDU中有可能本来就有0x7E，故为了实现*透明传输*，需要对SDU数据中的特殊字符来进行*转义*
- 转义的具体操作包括：
  
  ```
  0x7e -> 0x7d-5e
  0x7d -> 0x7d-5d
  所有小于0x20的字节 -> 0x7d-(原字节+0x20)
  如0x01 -> 0x7d-21
  ```

PPP协议的协商：

PPP协议允许通信双方对通信细节进行“协商”，使用的协议是LCP(Link Control Protocol)

### NIC

NIC(Network Interface Card)，网络接口卡，俗称“网卡”。

链路层主要通过NIC及其驱动程序来实现的。

### 多路访问网络&介值访问控制协议

多路访问链路也称广播链路，指一组主机共享同一传输介质。广播链路的好处是节省线材，容易支持广播；缺点是一旦有多台主机同时发送会导致链路中的信号相互干扰，称为*碰撞*

为了解决广播链路的冲突问题，一些专门由于处理广播链路冲突的协议称为**MAC(Media Access Control)**协议

目前，在多路访问链路中常将数据链路层细分为*LLC(Logic Link Communication)*层和*MAC(Media Access Control)*层

最著名的的多路访问网络协议是**以太网(Ethenet)**

Slotted：一种MAC策略，规定将时间分为若干等长的片，称为“槽（slot）”。帧只能在slot的开始发送，也即*将发送时机同步到slot起始时刻*.可以证明这一策略能提高效率减少碰撞。

历史上曾经出现过Slotted ALOHA协议，不进行载波监听直接发送，冲突则重传，效率是较一般的。

CSMA
- CSMA = Carrier Sense Multiple Access 载波监听多路访问
- 这是一种MAC策略，是指**发送前，需要监听信道是否空闲**
- 几种具体的CSMA：
  -  1-persistent CSMA （以太网采用）
     
     发送前先监听信道，信道空，立即发送；否则持续监听，直到信道空，立即发送
  
  -  non-persistent CSMA （常见于低功耗的场景）
     
     (1) 发送前先监听信道，信道空，立即发送；(2) 否则延迟一段随机长度的时间，转(1)
  
  - p-persistent CSMA

    类似1-persistent CSMA，但是在信道空的时候以概率p发送（区别于以概率1发送）

CSMA/CD协议
- 全称 Carrier Sense Multiple Access / Collision Detection
- 是以太网使用的MAC协议
- **CSMA/CD基本流程**：
  - 1-persistent CSMA, 信道空立即发送，否则持续监听至信道空再发送
  - 边发送边检测冲突，如果发送完毕都没有检测到冲突，则发送成功
  - 若发送时检测到冲突，则停止发送并发送32bit干扰位加强冲突信号
  - 冲突发生时采用*二进制指数退避算法*随机延迟一段时间再**回到1-persistent**（也即随机延迟之后不是立即发送，而是回到1-persistent持续监听的过程中）
- 监听信道的时候，必须要有一段连续时间的空闲才能算空闲。比如96b。
- 二进制指数退避算法
  
  基本做法：在第$i$次冲突时随机延迟$k$个时间片，其中$k\in Z$从区间$[0, 2^{\min(i, 10)}-1]$中随机选取。
  
  注意：
  - 第10次之后不再增大选取范围，因此该算法也称*截断式*二进制指数退避算法
  - 第16次冲突之后将不再重试，直接向上层返回发送失败。

  第$i$次冲突概率：
  $$
    \begin{cases}
    \frac{1}{2^{i-1}},\ i \le 10\\
    \frac{1}{2^9},\ i > 10
    \end{cases}
  $$

  冲突次数期望：
  $$
    0.64左右
  $$

### 以太网
以下内容为10Mbps以太网协议的规定


以太网MAC帧格式
```
  前导字符 目的地址 源地址 类型/长度 有效载荷 帧校验序列
```
- 前导字符包括7B的*同步字符*和1B的*起始定界符*，这一部分可以不视为帧的一部分
- 目的地址就是MAC地址
- 源地址也是MAC地址
- “类型/长度”字段
  - 该字段存在历史包袱
    - DIXv2格式：最初的格式，在该格式中该字段表示“类型”
    - 802.3帧（原）：该字段表示“长度”
    - 802.3帧（1997年修订）：也是现在的格式，表示类型/长度
  - 该字段原本表示的是上层协议类型，即SAP
  - 但有效载荷是变长的，且*最小长度是46B，不足的字节会填充*，不得不使用该字段表示有效载荷的真实长度
  - 但幸好，表示SAP的数值都大于1500（有效载荷最大长度）
  - 综上，使用如下表示规则：
    - 若该字段大于1500，则将其解释为SAP
    - 若该字段不足1500，则将其解释为有效载荷实际长度
    - 但这一策略仍然有问题：当类型/长度字段表示长度时将无法表示SAP。解决方案是增加抽象层次，拓展帧格式，在有效载荷中继续添加header以表示SAP
  - 实际上，目前的网卡实现基本都不会将该字段解释为长度，基本用不到那个复杂的拓展格式。也即**现在的以太网实现总是将“类型/长度”字段解释为SAP**，**由上层协议保证帧有效载荷长度不小于1500**
- 帧校验序列是CRC-32

关于以太网MAC地址：
  - MAC地址6B，分为三种：单播地址、多播地址、广播地址
  - 单播地址也称物理地址，一个网卡需要绑定唯一的MAC单播地址（网卡出厂时厂商保证MAC地址唯一）。但实际上网卡的MAC地址可以更改，且只需要在同一以太网中唯一即可。
  - 广播地址全1
  - 由于以太网实际上是广播信道，以太网网卡是会接收所有正确的帧的，对于单播/多播，网卡检查目标地址是否符合，

最短帧问题
- 问题出在以太网*边发送边检测冲突*，换句话说*不发送不检测冲突*。
- 由于传播时延，一个节点从发送到其冲突传播回到节点**至多需要2RTT**。为了保证当冲突到达发送端的时候发送端仍在检测冲突（也即*仍在发送*），必须根据网络带宽设置*最小有效载荷长度*，从而保证*最小帧长度*，保证在2RTT之内节点仍在发送。以10Mbps以太网为例，2RTT约等于51.2微秒，对应的最小帧长度是64B

**争用窗口**：
- 使用符号$\tau$表示
- 通常$\tau=2\mathrm{RTT}$。
- 争用窗口的意义是：若信道空闲，某主机准备发送数据，则在长度$\tau$的时间内，是有可能与其他节点产生冲突的。通俗地说，这一窗口内有可能出现相互*争用*信道导致冲突。
- 一般CSMA/CD的退避算法的延迟时间片也是$\tau$。这是因为如果退避时间片小于争用窗口

*PPPoE：

实际上，PPP协议用于点对点链路，但以太网作为一种广泛使用的有线广播型物理网络，提供的却是多路访问网络。某些时候我们希望在以太网的基础上使用*逻辑上的点对点链路*。在数据链路层，除了常用的LLC，还有一种PPPoE（PPP over Ethernet）的协议实现这种特性。



### 以太网的物理设备
- 最初的同轴电缆
  
  这种方案是真正意义上的完全共用物理介值。

  一台主机故障，整个网络的无法工作。早已淘汰。

- 集线器

  这种设备的行为就是简单地模拟同轴电缆总线的功能：收到信号立刻转发至所有其他线路，收到冲突则转发冲突。

  **集线器没有存储转发的功能**。从这一意义上说，集线器工作在物理层上（面向比特传输）。

  **集线器的所有接口共用同一个冲突域**。也即集线器连接的任何两个同时发送则会冲突。

  现已很少用了

- 交换机
  
  - **交换机具有存储转发的功能**
  - 交换机的各个端口**各自属于不同的冲突域**。这是因为交换机能够存储转发，检查目标地址，只将帧转发到合适的端口，故端口之间不会冲突

### 扩展局域网&透明网桥
- 用*网桥*连接若干个LAN可以建造一个更大的LAN，称为桥接局域网或者扩展局域网。
- 原来的局域网称为扩展局域网的一部分，称为该局域网的一个网段（Segment）

  其实“网段”有多种定义，此处取如下定义：

  **共享同一个冲突域的局域网称为一个网段**

- 由于网桥对局域网的拓展对主机是不可见的，换句话说，对于主机来讲拓展局域网仍然是一个局域网，具有统一的操作接口和协议。因此这样对主机透明的网桥设备也称为*透明网桥*
- 网桥工作在链路层，因为网桥面向帧进行工作。
- 网桥具有*一个*MAC地址，可以认为它是同时连接多个局域网的特殊主机
- 网桥对应的产品恰恰是**交换机**
- 网桥的三种操作
  - flood：网桥**广播**某一网段的发送帧到所有端口，同时**不将其发回发送信息的网段本身**，称为*泛洪（flood）*这一操作并不是真正的广播，因为发送网段自己没有接受这一广播
  - forward：若某一网段的主机*单播*信息，且目标主机是*另一个网段*的，且**通向目标主机的端口确定**，则网桥需要将信息转发（forward）目标主机所在的端口。
  - filter：若某一网段的主机单播信息，且目标主机是*同一网段*的，则网桥不做任何转发操作，简单地过滤（filter）掉或者说丢弃（discard）收到的帧即可。
- 网桥需要维护一个表记录各个主机所在网段，该表称为转发表。
- 转发表的*自学习*
  - 转发表具有*自学习*特性，每次主机发送帧的时候根据帧的源地址字段，自动记录该主机所属网段对应接口
  - 新入网的主机可能在转发表中没有记录，若此时有主机向该新入网主机的发送信息，网桥会直接flood该帧
  - 由于网络拓扑结构可能会变化（比如一台已经有记录的主机从一个网段转移至另一个网段），转发表的记录可能会*过期*。因此网桥会为每一条记录设置TTL（生存时间）。当记录过期时，网桥将该记录删除。
  - 因此，完整的网桥自学习策略是：
    - 当收到一帧，若源地址没有记录，则添加转发表记录；若源地址对应记录已存在，则**更新转发表记录，重置TTL**
    - 当一条记录超时了，删除该记录
  - 实际上，由于实际的网络中的主机总是在发送帧，这一策略往往可以保证转发表对网络的拓扑结构是最新的。
- 多网桥与广播风暴
  
  考虑多个网桥构造的有环的网络链路拓扑结构。若网段1的主机发一帧给一台在网段2中的不在转发表中的主机，网桥1先收到这一帧后，只能使用flood操作向网段2广播。flood操作之后，链路有环，网桥2收到来自网段2的广播后，也需要flood，在网段1中广播一帧。此时网桥1在网段1中又收到了一帧，再次向网段2广播。如此反复，导致局域网中无休止地传输同一帧。这一现象称为*广播风暴*

  广播风暴的根源是链路的拓扑结构中有回路

  解决广播风暴的最直接方法是新加入的目的主机随便发送一帧。这样就可以更新所有网桥的转发表。有了转发表的记录，以该主机为目的主机的单播帧不再需要flood而是forward，从而消除了广播风暴。

  更系统的方法是将网络拓扑结构简化为*生成树*

- 生成树协议
  - Bridge ID（BID）由2B的“优先权”（默认都是32769）和6B的网桥MAC地址构成。
  - 我们规定，**BID最小的节点是根网桥**
  - 利用配置消息BPDU来建立生成树
    - BPDU包含当前根BID，到根的距离，发送BID，发送端口
    - 一开始，所有的网桥以自己为根向其相邻网桥发送BPDU帧。
    - 一轮发送后，所有节点都会收到相邻节点的BPDU帧。根据收到的BPDU，若发现收到的BPDU*优于*自己，则调整策略，认为该较小的BID才是根，并以此结论为基准发送新的BPDU
    - 在若干轮BPDU多播之后，最终只有局域网中BID最小的网桥才被公认为根，且所有网桥都可以计算出到根网桥的最短
  - 所谓“优”，是指对BPDU的`<根桥ID，根开销，发送桥ID，发送端口>`按照字典序比较，字典序较小的BPDU视为“更优”的BPDU
    - 也即先比较根桥ID，较小者为更优
    - 根桥ID相同，根开销较小者更优
    - 根桥ID相同，根开销相同，发送桥ID较小者更优
    - 根桥ID相同，根开销相同，发送桥ID相同，发送端口较小者更优
  - 有了所谓“优”的定义，我们有如下两个概念：
    1. 端口最优配置消息
       
       对于网桥的每个端口，都有一个**端口最优配置消息**，它是目前从该端口收到的最优的配置消息

    2. 网桥最优配置消息
       
       比较所有的端口最优配置消息和网桥自己产生的配置消息，从中选最优的，然后对其做计算改写生成以自己为发送桥的一个最优的配置消息，称为网桥最优配置消息

  - 每个端口选择到根网桥的最短路所走的端口进行转发。称此端口称为*根端口*。实际操作中，选择具有最优配置消息的端口作为根端口（显然如果是自体消息最优则当前桥为根，没有根端口）
  - 每个网段只匹配距离根最近的网桥，该网段连接该网桥的端口称为该网段的*指定端口*。实际操作中网段的指定端口由网桥来决定。网桥会比较每个端口的端口最优配置消息和当前桥的网桥最优配置消息，若比不过，则该端口是（属于某网段的）一个指定端口。
  - **数据帧只能通过根端口和指定端口进行通信**。既不是跟端口又不是指定端口称为阻塞端口。
  - 拓展思考：为什么简单地使用BFS构造生成树。原因是这些节点没有共享存储器，通信完全依赖消息。也即，如果将局域网系统是*不共享内存*的*对称多处理*系统，所以采用的算法可说是*分布式算法*，因此不能简单地使用BFS

### 虚拟局域网
与扩展局域网相反，扩展局域网试图利用网桥将在物理上分离的多个局域网连接在一起，虚拟局域网（VLAN）试图**将在物理上相连的多个主机分离成多个虚拟的逻辑上独立的局域网**。主要实现手段就是为网桥的各个端口配置VLAN ID，帧只在VLAN ID相同的端口之间通信。

若同一个VLAN的主机连在多个不同网桥的上，则必须允许网桥之间的连接能转发VLAN ID不同的帧。称网桥之间的链路端口为*Trunk端口*。实际上，只有在Trunk端口上传输的帧才需要加VLAN ID

VLAN改动了协议头部，但仍然可以采用以太网，且可以不改动以太网帧结构：令类型字段使用0x8100取值，然后扩充的字段放到有效载荷部分。

### 交换机

交换机基本构成和原理是：
- 多个端口，每个端口配置一个缓冲区（用于存储转发、排队）
- 使用*交换结构*（Switching Fabrics）来进行端口之间的数据交换

几种常见的交换结构
- 总线式：端口共享一根总线，使用某高速总线协议来交换数据，有点是价格低廉
- 纵横式：每个输入端口引一根线，然后每个输出端口都有一根线连在这根线上。性能较高，价格较贵，用的较少

转发方式：
- 存储转发（Store and Forward）：交换机从端口接收到了整个帧之后再转发。这是最符合理论的操作，大部分交换机都是这种方式。
- 直通（Cut through）：收到header，解析完成后，立即逐bit转发。类似集线器的工作模式。容易证明这种方式比存储转发快。问题是可能由于争用窗口问题导致冲突
- 无碎片（Fragment free）：同直通，只不过要收到64B再转发。由于争用窗口长度，可以避免冲突。
- 适应性交换（Adaptive switching）：自适应使用采用以上三种方式中的一种。
- 实际产品中广泛使用了直通（意味着其效率提升得到实践的验证）

全双工模式：

如果交换机常常是直连主机的，则可以通过连接两对线分别用于发送和接收，来实现*全双工通信*。（注意由于是全双工通信，可以关闭CSMA/CD）

自适应：

站点周期性使用快速链路脉冲进行*协商*，自适应选择10M/100M/1000Mbps的以太网

