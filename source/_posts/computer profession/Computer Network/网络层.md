---
title: 网络层
date: 2021-06-23 23:56:18
updated: 2021-06-23 23:56:18
tags:
- 专业课
---
## 网络层

### 交换技术
- 电路交换（Circuit Switch）
- 包交换（Packet Switch）
  - 虚电路
    - 交换式虚电路（暂时的）
    - 永久虚电路
    - 虚电路是有有连接的
    - 可以保证带宽
    - 虚电路基本被淘汰了。因为需要保证带宽的情形直接租用专用物理线路即可。
  - 数据报
    - 数据报是无连接的
- 两种交换技术的根本区别在于信道复用技术。
  - 电路交换采用TDM/FDM/WDM/CDMA信道复用技术
  - 包交换采用的是统计多路复用技术
- 分组交换的两种方式的根本区别在于**是否在

### 网络层服务模型
- 恒定位速率：固定速率，无差错，无拥塞
- 可变位速率：确保速率，无差错，无拥塞
- 可用位速率：最小保证，可用于ATM机
- 未指定位速率
- 因特网：尽力交付：无带宽保证，可能丢包，可能乱序（总之就是没有底线）

### IP地址
- IP地址是**全局地址，全球唯一（公网IP）**
- IP地址是**按层分配**（具有树状的子网结构）

### IP数据报

头部格式：
```
  版本(4b) 头部长度(4b)  服务类型(8b)                 总长度(16b)
             标识(16b)  未分配(1b)  DF(1b) MF(1b) 片段偏移量(13b) 
  生存期(8b)   协议(8b)  头部校验(16b)  
              源IP地址(32b)
              目的IP地址(32b)
  选项（至多40b）   填充
```

头部字段详解

1. 版本

   只用两种：IPv4和IPv6

2. 头部长度
   
   由于只有4b，因此该数值的单位是*4字节*，也即头部长度最大只有60B

   此外，4字节为单位的长度导致头部的长度必须**4字节对齐**

3. 服务类型

   最初为了指明四种服务要求（低延迟，高吞吐量、高可靠性、最小花费）和优先权。

   但实际上，这些特性都没有实现。（因为网络环境复杂，总是有数据报要求所有的服务要求和最高优先权）

4. 总长度：数据包的长度，单位是字节
5. 标识符
   
   也即包的*编号*

6. 片段偏移
   
   若IP数据包的大小超过了链路层的*最大传输单元（MTU）*（也即最大有效载荷，**不等于最长帧长度**），不得不对IP数据报*分段*
   
   - 每个分段都有自己的头部
   - 分段之后的IP数据报标识符相同。
   - 此时需要这个字段记录了各个段的**数据部分**相对于**数据部分起始位置**的偏移量
   - 此时偏移量的单位是*8字节*（因为IP数据报长度字段是16bit的，但偏移量字段只有13bit，因此是以8字节为单位）。注意，因为是8字节为单位，故划分的时候要对齐8字节。
   - 到达目的主机之后需要重组这几个分段

7. MF,DF

   由于每个片段具有独立头部，故未分段前的IP包的总长度位置，因此若最后一个片段丢失，重组时无法发现。因此需要MF（More Fragment）标志表明当前是否是最后一个片段（非最后片段：MF=1；最后片段：MF=0）

   DF（Don't Fragment）标志表示不要划分。若IP数据报长度大于MTU，又设置了DF，路由器只能丢弃该报了。


8. 生存期（TTL）
   
   使用该字段的根本目的是internet可能有环，为防止不合适的路由选择策略导致数据包无限地绕圈，路由器丢弃超出生存期的包。

   不同于物理网络不具有清除绕圈的包的能力（广播风暴），采用生成树算法解决构造合理的拓扑结构，互连网络采用TTL来定期清除绕圈的包。这其实是因为构建互连网络是不可行的。

   使用秒不实际，该TTL的单位是*跳*。
   
   **每经过一个路由器，TTL-1**。**当TTL归零时，路由器不再转发该数据报**，并且向源主机发送ICMP报文。

   TTL的取值一般是64（Linux）或者255（Windows10）。通常TTL的取值参考的是*Internet的网络图半径的两倍*
  
9.  协议
   
    该字段就是所谓的SAP，记录**上层协议**。主要的上层协议主要是TCP和UDP。

11. 头部校验
   
    使用*校验和*来校验头部。**仅校验头部**

    使用校验和有一个小效果，就是每经过一个路由器，TTL都要减1，从而头部校验也必须相应变更。但由于使用校验和，而且TTL字段是16位对齐的，因此不需要重算整个校验和，只需要相应减1即可（由于存储的是反码，实际上是+1）

11. 源IP地址
12. 目的IP地址

### 数据报分段

若IP数据包的大小超过了链路层的*最大传输单元（MTU）*（也即最大有效载荷，**不等于最长帧长度**），不得不对IP数据报*分段*
   
- 每个分段都有自己的头部
- 分段之后的IP数据报标识符相同。
- 此时需要这个字段记录了各个段的**数据部分**相对于**数据部分起始位置**的偏移量
- 此时偏移量的单位是*8字节*（因为IP数据报长度字段是16bit的，但偏移量字段只有13bit，因此是以8字节为单位）。注意，因为是8字节为单位，故划分的时候要对齐8字节。
- 到达目的主机之后需要重组这几个分段
- 若超时限时内不能收到同一个包的所有片段，则视为重组失败，丢弃该包。

由于每个片段具有独立头部，故未分段前的IP包的总长度位置，因此若最后一个片段丢失，重组时无法发现。因此需要MF（More Fragment）标志表明当前是否是最后一个片段（非最后片段：MF=1；最后片段：MF=0）

DF（Don't Fragment）标志表示不要划分。若IP数据报长度大于MTU，又设置了DF，路由器只能丢弃该报了。此时路由器一般会发一个ICMP包给源主机

DF是实现了的。DF可以用于*路径最小MTU发现*。因为根据路径最小MTU构造适当大小的IP包避免分段可以提高性能。

### IP地址

IP地址跟MAC地址都是全球分配（一般是全球唯一）的。

相比MAC地址，IP地址除了作为主机的唯一标识，还包含了表征*网络互连*的特征。更具体地说，IP地址具有*网络号*分量和*主机号*分量。这一特性使得IP是*可路由的*：某一具体主机所在的网络可以直接从IP地址中得知，因此路由只需要针对主机所在的网络就行了。

IP地址可以分成两部分：
1. **网络号**
2. **主机号**

IP地址 = 网络号:主机号

#### 有类网

传统的IP分类分5类：A类到E类

- A类：
  
  0.x.x.x ~ 127.x.x.x

  起始位为0，首字节为网络号，后3字节为主机号

  A类网络一共只有128个，但每一个网络具有非常多的主机

- B类：
  
  128.x.x.x ~ 191.x.x.x

  起始位为10，前2字节为网络号，后2字节为主机号。

  B类网络共16384个，每个网络也有不少的主机可用。

- C类：
  
  192.x.x.x ~ 223.x.x.x

  起始位110，前3字节为网络号，后1字节为主机号。

  C类网络很多，但每个网路只有至多256台主机。

- D类：
  
  224.x.x.x ~ 239.x.x.x

  起始位1110

  多播地址，不做常规使用

- E类：
  
  240.x.x.x ~ 255.255.255.255

  起始位1111

  保留，未使用

传统的有类网问题很多：
- A、B类网络的网络数目太少，网络号会迅速耗尽
- C类网络中一台主机太少了
- 不启用E类地址，使得本就紧缺的IPv4地址空间更加不够用

传统有类网不够灵活，不便于实际使用。目前有类网只是IP地址的管理机构管理地址的标准。

#### 有类网：划分子网

传统有类网不够灵活，现在采用*子网划分*的手法了配置IP地址。

将原来的网络划分为更小的*子网*，子网划分的大小可以根据实际需要连接的主机数目，因此比传统分类IP地址更灵活。

为了划分子网，从原来的主机号中划出多若干个位用于标识子网。原来的网络号拼上子网的编号，得到*子网号*

注意，我们规定：
- 类似网络号，**子网号必须唯一**。
- **主机号不能是全0或全1**
  
由于子网号是变长的，通常采用*子网掩码*来告知主机如何解释IP地址。

取IP地址“与上”子网掩码来得到子网号。

#### 无类网：构成超网

在原来的有类网上划分子网只能将原有的网络化成更小的，**划分子网无法为一个网分配更多的主机**

通过引入所谓的*无类域间路由选择协议（CIDR）*，现在允许将多个原来的有类网合并为一个更大的网，称为*超网*。

为了实现构成超网，需要*将网络号的划作主机号*。类似的，同样需要子网掩码来确定网络号。

引入构成超网之后，现在的网络号已不再具有典型的5类划分，因此*构成超网方案可以说是无类网*。

CIDR显著减少路由表中的表项数目，这一特性称为*路由聚合*。

#### 特殊的IP地址：
- 网络号是0，主机号非0：
  - 仅能用作源地址
  - 表示与目的地址处于同一网路中
- 网络号&主机号都是0：`0.0.0.0`
  - 仅能用作源地址，有两种常见含义
  - 不限制源地址（服务器监听任何来源）
  - 源地址不可知（安全考虑）
- 网络号非0，主机号为0：
  - 这不用作地址来使用，而是在理论上作为*网络号*的记号
- 网络号全0，主机号全1：
  - 这是本网络的广播地址，对应链路层的广播帧
- 网络号非0，主机号全1：
  - 向某特定网络广播的广播地址
- 私有地址：
  - 10.0.0.0 ~ 10.255.255.255（这是一个A类网）
  - 172.16.0.0 ~ 172.31.255.255 （这是16个B类网）
  - 192.168.0.0 ~ 192.168.255.255（这是256个C类网）
  - 这三个IP地址空间都是*私有地址*，**不需要向管理机构申请即可使用，不是全球唯一的，不可在公网上使用**（主干网的路由器会把这些IP作为目的地址的包滤掉）
  - 这些地址都是配合NAT使用的*专用网*地址
  - 具体用法详见NAT/NAPT部分
- 环回地址：
  - 127.0.0.1 ~ 127.255.255.254
  - 这些称为*环回地址*。这些IP都指向本机。
  - 特别地，我们通常使用127.0.0.1即可
  - 默认情况下PC还会配置一个静态域名localhost，对应的就是127.0.0.1


### NAT/NAPT

实际上无论是子网划分，还是构成超网，实际上都没有拓展IPv4的地址空间：**无论如何划分，一个IP地址都只能对应一台主机**

结合私有地址，NAT协议

（待完善）

### ARP

（待完善）

### DHCP：动态分配ip

全球IPv4公网IP资源有限，大部分被美国机构占用了。（尤其在中国）大量用户需要从持有公网IP的机构*租用*ip地址。此时，需要*DHCP（动态主机配置协议）*

DHCP协议底层使用UDP协议向DHCP服务器发送请求，请求服务器为其分配一个可用的IP。

DHCP归属的网络分层比较特殊：
- DHCP名义上在底层使用IP传输，但实际上只能工作在直连网中
- DHCP使用UDP封装数据
- DHCP有自己的协议数据头

因此，一般说DHCP是跨三层工作的应用层协议。

要点：
- DHCP协议虽然使用UDP，但实际上底层用的是**LAN广播帧**。使用UDP/IP是为了编程方便。事实上，该UDP报文的源IP是`0.0.0.0`（注意是特殊IP，表示源地址不确定），目的ip地址是`255.255.255.255`，代表广播。
- DHCP四个步骤：
  1. discover: 用户向DHCP服务器索要ip地址
  2. offer: DHCP服务器向用户提供可用的ip地址
  3. request: 用户收到offer之后，确认接受offer，租用DHCP提供的ip
  4. ack: DHCP服务器确认收到了用户的request并正式将ip分配给该客户
- 先请求offer再决定是否租用的原因是DHCP消息是广播的，而LAN中可能存在多台DHCP服务器，这可能导致用户主机收到多个offer，用户主机只选择其中一个offer并发送request接受offer
- 实际上DHCP消息不会被路由转发，因为这是无目标的广播

### ICMP（网络控制消息协议）
这是一个直接使用IP协议而不使用TCP/UDP的消息协议。**该协议的最主要作用是诊断互连网络的问题**

通常分为两大类：
1. 查询消息
2. 差错消息

最典型的查询消息是经典的控制台工具*ping*所使用的“回显请求”和“回显应答”消息。

关于ping回显的要点：
- 若没有差错，收到回显请求的主机会向源主机发送“回显应答”消息；否则，源主机会收到响应的ICMP差错消息。
- **需要“回显请求”和“回显答复”两个ICMP消息传输成功才最终能“ping通”**。有些时候容易忽略目的主机收到回显请求但回显答复没有正确到达源主机的情况。**回显答复因某种原因无法到达源主机会导致“超时”**而不是具体的差错消息。
- 如果在中间某个路由器已经出错，则由出错的路由器向源主机发送ICMP差错报文。
- 部分主机（比如多数Windows10的个人电脑）会设置防火墙丢弃（不应答）回显请求导致“ping不通”。但此时不表明网络不通。

差错消息：
（待完善）

### RIP

RIP：路由信息协议(Routing Information Protocol)

该算法的核心工作原理是**采用邻居的路由表构造自己的路由表**。

要点：
- 路由表中到目的网络的距离以跳为单位，**最大为15，距离16表示无穷大，或者说不可达**
- 初始时RIP路由表中只有直连网的路由信息，且距离为1
- 每个30s将自己的路由表发送给邻居，以便更新路由表
- 每次收到来自邻居的路由表，使用如下策略更新路由表：
  - 首先对收到的路由表的所有的距离+1
  - 若到某个目的网络的路由在原来的路由表中不存在，则加入路由表
  - 若到达某网络的路由较目前表中的距离更小，则更新路由表
  - 若到达某网络的路由从其“下一条”路由器传来新的距离，则无条件更新距离
  - 路由表每项都有TTL，更新的路由记录同步重置TTL

RIP中的一些问题

1. 慢收敛
   
   路由表的更新传播到远端路由器需要的时间很长

2. 计数到无穷
   
   由于更新策略，导致某条被置为无穷的路由记录被邻居out-dated的记录更新回去，最后震荡计数缓慢收敛至无穷。虽然最终稳定态的结果是正确的，但收敛的速度很慢。

RIP中的一些技术：

1. 水平分割
   
   从一个接口学得的路由不该从该接口发回去

2. 毒性反转
   
   从一个接口学得的路由从该接口发回去的时候，距离改为无穷大

3. 抑制
   
   距离被改为无穷大的路由在一段时间内不允许被修改，防止抖动

4. 触发更新
   
   一旦出现路由变化，立刻将变化的路由发给邻居，原来的30s发一次完整路由表不变
  
### OSPF

基本策略：

将AS拓扑结构建成图，使用单源最短路径建立路由表。

建图策略：

1. 末端网：只连一条入边
2. 广播型网络：与所有相连路由器建立双向边
3. 点到点网络：类似末端网，只有入边，但点的两端的路由器还需要连双向边
4. 每个路由器利用*链路状态通告(Link State Advertisement, LSA)*将**出边**广播到所有路由器。
5. 每个（广播型的）中转网需要选举一个指定路由器，作为代理负责发送中转网节点对应的LSA
6. 每个路由器使用邻接矩阵存储收到的LSA，并更新数据库
7. 最终AS中每个路由器中的图结构都同步到完全一致

OSPF基本步骤：
1. 邻居发现
   （待完善）
2. 同步至完全相邻
   （待完善）
   1. 生成LSA
   2. 扩散LSA
   3. 收集、更新LSA
3. 计算最短路径
4. 建立路由表

LSA格式：

LSA的主要作用是同步网络图数据库，因此根据建图策略，主要有两种LSA：
- Router LSA
- Network LSA

OSPF的一些特点：
1. 所有OSPF消息都要认证（防止恶意认证）
2. 协议规定，路由表可以保存多条相同开销的路径，实现负载均衡
3. 支持多播
4. （对比RIP）收敛更快
5. （对比RIP）更“安静”：若链路状态不变，每30min才扩散一次（但实际上，每10s需要Hello一次，其实没有那么明显）
6. （对比RIP）实现更复杂，需要计算开销更大（需要实现Dij）