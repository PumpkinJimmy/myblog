---
date: 2021-10-20 10:05:48
title: 全局光照：光线追踪

---

# 全局光照：光线追踪

## 冯氏光照的问题

最大的问题是**无法精确模拟全局光照**。

具体地说：
- 冯氏光照简单粗暴的全局光照明：

  在处理局部光照明的时候冯氏模型考虑了漫反射和镜面反射，精度已经不错了；

  但处理全局光照时，冯氏光照直接将照明近似为一个全局常量和一个系数。

- **物体与物体之间的存在光层面上相互影响**

  尤其是当场景中存在多个镜面表面的物体时，同一束光反射多次，冯氏光照模型完全处理不了。

  最简单的例子：渲染镜子。

  在冯氏光照中，镜子除了提供强镜面反射之外，完全没有照出周围环境和物体的能力。

## 光线追踪法

### 针孔摄像模型

说是说“光线追踪”，其实实现的时候是“视线追踪”。

我们将成像平面建模为*针孔摄像机阵列*。

基本的思维方法是从观察点向针孔相机方向引一条射线，然后根据光学基本原理追踪射线路径，最终找到给定点的光照取值。

### Ray Casting（待完善）

### Whitted-Style Ray Tracing（待完善）

### 求交

有了光线追踪模型，接下来的问题就是：如何高效地求射线与模型的交点。

#### 一般模型求交

若有模型的隐函数表达，那就只能联立求解了。

但由于模型一般是三角网格，所以很多可以把问题化归为与三角形求交。

#### 平面求交

略

#### 三角求交

利用*重心坐标*来计算。

实际上可以联立线性方程组求解，即可判断射线与三角面片是否有交以及交点重心坐标。

### 计算瓶颈

光线追踪的主要瓶颈是
- **每个像素对应一条射线**
- **每条射线需要与场景中所有模型求交**
- **每条射线可能被反射/折射多次**

## 光线追踪加速

光线追踪效果出众，而数学建模并不复杂，但计算瓶颈巨大。

关于光追的学问主要是如何加速计算。

常见方法：
- Bounding Box / Bounding Volumn
- 体素
- 八叉树
- KDTree/BSP Tree
  
### 体素化（均匀网格）（待完善）

### AABB

AABB: Axis-Aligned Bounding Box

包围盒平面对齐轴面。这样的包围盒非常容易求交。

具体来说，一共三对六个轴向平行的平面，快速求出三对交点，如果三对交点每对都有一个点进入了包围盒，那就有交了。

### 空间划分：八叉树/KD树/BSP树
- 八叉树：把空间等分为八个卦限
- KD树：沿着*轴向*把空间二分
- BSP树：沿着*任意方向*把空间二分

### KD树

KD树可以认为是线段树的高维推广。

用在光线追踪时，我们是这样处理的：
- 由于沿轴向剖分，**KD树的每一个区间对应空间中的一个AABB包围盒**
- **将截断成线段，当作区间查询**
- 判定线段是否全包含某个“区间”利用的是AABB相较判定

缺陷：
- 如何选择划分标准
- 同一个物体可能属于多个不相交区间，因此同一个物体可能被求交多次

### BVH

BVH: Bounding Volume Hierarchy

如果一个对象被可以属于多个区间会造成麻烦，那**按对象划分就好了**。代价是此时不同分组物体的包围盒可能是重叠的。
