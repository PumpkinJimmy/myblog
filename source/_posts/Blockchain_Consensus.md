---
abbrlink: '0'
date: 2021-09-23 11:12:09
---
# 区块链共识机制
## 共识的定义
A process of agreement between distrusted nodes on the final state of specified data.

### 说明
定义中的关键字：
- 共识是*达成一致*的过程
- 共识是针对*相互不信任的节点*之间的操作（这暗示了运用共识的常见场景就是分布式系统）

## 一致性
### 一致性的要求
（待完善）

### 一致性的问题和挑战
- 网络是不可靠的
- 节点的处理时间是没有保障的
- 节点可能是恶意的
- 同步调用会严重降低分布式系统的可拓展性

### 可能的解决方案
- 同步调用
- 提前约定
- 第三方中心调度（不适合去中心化的区块链）

## 共识机制
### 定义
A set of steps taken by most/all nodes in a distributed system(e.g. blockchain) to agree on a proposed state or value

### 主要特性
- Agreement 一致性（基本要求）
- Termination 可终止性
- Validity 合法性：鉴别提案节点的身份
- Fault Tolerance 容错性
- Interity 完整性

### 核心要求
- 活性：节点可以在有限时间内得到响应
- 安全性：数据在节点之间保持严格一致
- 正确性：


### 主要类别
- BFT-based 基于拜占庭容错的共识算法
  - 性能较高
  - 只使用在小规模的系统
  - 可拓展性差

- Leader Election-based 基于选举的
  - “赢家通吃”：只有最终的胜利者能够提出最终取值
  - 可拓展性很好
  - 性能很低

## 区块链共识机制
- 公链
  - 几乎可以加入任何节点
  - 参与者完全不存在信任
  - 使用算力敏感的PoW机制
  - 代表项目是比特币
- 联盟链/私链
  - 节点加入系统需要审查，节点之间具有信任基础
  - 节点较少
  - 可以使用BFT-based的高效共识算法

## 拜占庭容错
拜占庭容错（BFT）来源于拜占庭将军问题：
- 拜占庭的将军们分布在各地
- 关于是否开战的问题需要将军们达成共识
- 在通信过程中可能有外敌干扰

为解决拜占庭将军问题而设计的策略就是*拜占庭容错(BFT)*

### 前提条件
- 至少4个参与者
- 每轮次至少一个发令者
- 少于1/3的恶意参与者、失效参与者
- 极大概率可达网络
- 可控的网络规模（少于100参与者）

完整的拜占庭容错模型（PBFT）考虑三类节点：
- 正常节点
- 失效节点
- 恶意节点

RAFT是简化版的PBFT，只考虑两类问题：
- 正常节点
- 失效节点

## 比特币常见攻击
- 双花攻击
  
  将同一个比特币承诺输出给两个不同的人。

  注意：由于两个交易分属不同区块，不同节点以不同顺序收到这两个区块，导致两个交易中有一个随机失效，**不同节点的账本不一样**

  解决方案：*同等验证*：全网必须为每一笔交易投票达到一定票数的区块才是有效的，因而全网账本保持同步。

- 多重身份攻击/女巫攻击
  
  比特币网络中创建身份的代价极低（创建一对密钥的事）

  若结合双花攻击，每个身份都允许参与投票则**可以通过伪造大量身份来允许双花**

  女巫攻击有效的根本原因是**投票没有成本**

  解决方案：**提高投票代价**，也即**工作量证明(Proof of Work, PoW)**

  PoW对抗女巫攻击的原理是：**基本有无限的身份，每个身份也只有有限算力**。哈希是谜题友好的，不存在捷径，**想要在投票中占有一票，必须给出足够的算力而不是给出一对没有成本的密钥所代表的身份**

  通过奖励解谜成功的节点，解密成功的节点可以在区块中加入自己获得比特币的一笔交易。这就是挖矿。

  实际上PoW机制导致挖矿类似“公平的买彩票”

## 比特币挖矿

挖矿本质是一种节点参与基于PoW机制的共识机制，获得奖励的机制。

注意挖矿问题的完整描述如下：
- 计算数Nounce，使得对于给定的**上一个区块的**Hash、默克尔树根Hash、时间戳，**拼接上Nounce之后做Hash得到的值的前k位为0**，其中$k$就是谜题难度。

### PoW特点
- 不容易完成（基本特征，表明该需要工作量）
- 容易验证（其他节点可以很快验证确实付出了工作量）
- 工作过程公平（不存在解决问题捷径）
- 具有随机性（算力大只能保证完成概率高，而不是赢家通吃，避免垄断）

### 挖矿奖励与通缩
作为付出巨大算力来维护比特币公链分布式系统的奖励，成功求解正确的Nounce的节点会拥有**当前节点的记账权**，可以**在常规交易的最后附加上一条自己获得比特币奖励的交易记录**。注意奖励是固定的，不能随意自定。

初始的奖励是50个，但**每隔21万个区块奖励自动减半**。最终，整个比特币系统中流通的比特币数目不超过2100万个。

因此，比特币相当于一种通缩的货币。

### 算力

比特币挖矿硬件的发展路径：CPU计算->GPU计算->FPGA计算->ASIC专用Hash矿机->矿池

截至2018年，全网算力达到$2.6\times 10^{18}$次Hash计算每秒（全球500强超算算力之和的100倍）

中国年均发电量4W亿千瓦时；
比特币全网挖矿好点1k亿千瓦时，这样的用电量大于多数小国家一年的用电量。

## 共识机制的局限性



### FLP不可能原理
可以证明：

**在网络可靠，但允许节点失效的最小异步模型系统，不存在一个可以解决一致性的确定性算法。**

说明：
- 以上原理称为*FLP不可能原理*
- 现实中，网络往往不可靠，这里是一个理想化假设
- 所谓*允许节点失效的最小异步模型系统*是允许非常少（甚至是一个）的节点失效的异步模型

FLP原理的等价表述是：**异步分布式系统不能同时保证活性和安全性**

### 折衷
- 弱化活性
  
  BFT-based共识机制可以保证安全性，但不保证活性

- 弱化安全性
  
  Election-based共识机制可以保证活性，但不保证安全性


## 比特币面临的挑战
- 挖矿能耗
  
  年均耗电量超过全球160多个国家

- 可拓展性
  
  比特币网络的吞吐率很低。其交易吞吐量低于中心化支付系统的2-3个数量级

- 安全性
  
  比特币网络本身是相对安全的，但比特币网络低下的协议却不一定。

  一个例子是基于区块链网络的智能合约。由于智能合约是一串**图灵完备的源代码**，一旦这段代码存在漏洞，则可以针对合约本身进行攻击


## 新探索：PoX
- PoS：Proof of Stake 基于股权的证明
  
  假设持有股权分额更大的节点更倾向于维护系统运行的规则，因此将共识的最终达成依赖于持有更多货币的节点

  优点是比PoW高效得多

  缺点是马太效应严重，货币会迅速集中到个别用户手中，然后这些用户会完全垄断系统的运行