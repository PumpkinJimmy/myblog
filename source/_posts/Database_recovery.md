---
date: 2021-12-27 10:29:38.351026+08:00
title: 数据库恢复

---
# 数据库恢复

## 日志
- 日志记录类别
  - 事务启动：`<Ti, START>`
  - 写操作：`<Ti, X, V1, V2>`
  - 事务提交：`<Ti, COMMIT>`
  - （读操作不需要日志，因为不涉及恢复）

- 由于事务并发，属于不同事务的日志记录是交错出现的
- 写操作日志
  - **先写日志，再写数据库**
  - **事务未提交，数据可能还没写盘，但日志就已经写盘了**
  - 记录组成：
    - `<tid, X, V1, V2>`表示事务ID、修改的键、旧值、新值
  - 明明日志记录的信息比数据库本身还要多，为什么还要区分日志和数据库
    - 数据库数据本身的组织结构更高效，它只保留当前值、存储布局考虑效率、存在索引；日志记录是Pile起来的、基本没有结构

- 事务日志记录详解：
  1. 启动事务时，写`<Ti, START>`
  2. 每次写操作，先写`<Ti, X, V1, V2>`，再写内存/磁盘数据
  3. 提交事务时，**先写`<Ti, COMMIT>`记录，再写数据**

- 日志基本操作
  - Undo 将一条写日志记录涉及的行写回旧值
  - Redo 将一条已经Undo的日志记录涉及的行写回新值
- 事务回滚
  - **按照记录顺序从后向前Undo给定事务的操作**
  - 每次undo写一个记录，就**添加一个新的记录`<Ti, X, V>`**
  - undo结束，添加日志`<Ti, ABORT>`
- 事务重做
  - 从前往后顺序写回新值
  - **重做过程不新增任何记录**

- 恢复
  - 有START无COMMIT/ABORT就要UNDO
  - 否则REDO