---
abbrlink: '0'
date: 2021-09-24 15:02:14
---
# 分布式系统的进程与虚拟化
## 上下文
- 处理器上下文
  - 寄存器
- 线程上下文
  - 处理器上下文
  - TCB
- 进程上下文
  - PCB
    - 处理器上下文
    - 线程上下文
    - 优先级
    - IO信息
    - 内存指针
    - MMU（页表指针）
    - TLB（块表）
    - 记账信息
  - 数据段
  - 代码段
  - 栈

容易发现：
- 进程上下文切换开销较大；线程切换开销较小
- 进程切换通常需要模式切换（使用系统调用）；线程切换不一定要陷入OS
- 线程之间共享地址空间：
  - 一方面，它允许线程之间通过共享变量来通信
  - 另一方面，线程之间共享地址空间可能导致相互干扰，隔离性不如进程

更严重的，线程之间隔离性差的问题可能导致*旁道攻击*

上下文切换的开销：
- 直接的：执行切换所需要的处理器时间
- 间接的：流水线清空，Cache失效、刷新（**实际系统中间接开销才是主要的开销**）

## 线程实现
### 用户级线程
现在的线程功能通常是用户态库提供*用户级线程*（如Pthread）。它的切换开销较小。

### 内核级线程
性能一般，但是可以充分利用多核

### 混合
实际上在内核级线程和用户级线程混合使用才是最优的。


## 虚拟化
### 系统接口
从软件到硬件直接一共涉及三层的“接口”：
- ISA：处理器的*指令集*
- ABI：应用程序二进制接口，很大一部分是*系统调用*
- API：应用程序编程接口，主要是库函数接口

### 虚拟化技术
1. Process VM 进程虚拟机
2. Hosted VMM 主机虚拟机监控器
3. Native VMM 原生虚拟机监控器

### Process VM 进程虚拟机
- 它是**对ISA的虚拟化**
- 它有时是运行在OS上的*解释器*，典型例子是JVM
- 有些Process VM是一种*模拟器*，可以模拟出各种ISA，典例是QEMU。但通常模拟器的性能损失非常大，可以达到一个数量级

### Hosted VMM 主机虚拟机监控器
- 它需要寄宿于宿主机OS上
- 它是**对硬件的虚拟化**
- 最主流的虚拟化平台技术
- 宿主机的OS的主要作用是执行涉及特权指令的操作（即系统调用），非特权指令是用户模式下在虚拟环境中执行的
- 技术瓶颈主要是一些特殊操作难以处理（称为*敏感指令*）：
  - 一些指令会影响机器配置（如修改中断表的指令）
  - 一些指令的效果取决于处理器上下文
- 想要做Hosted VMM，必须要敏感指令是特权指令的子集才行，但通常宿主OS不满足条件
  - 早期方案需要修改宿主OS，现已彻底抛弃
  - 现代方案是硬件虚拟化
- 典型的产品包括
  - VMWare/VirtualBox
    - 虚拟PC的概念，可以将虚拟机当作主机的一个应用程序来运行
    - 真正的同时运行两个系统
    - 有一定的性能损失
  - KVM
    - 绑定Linux宿主系统，是Linux内核的一部分
    - 需要硬件虚拟化的支持
    - 寄宿系统支持Linux，Windows等
    - 性能高，开源免费
    - 采用的是“多启动”，或者说同一时刻实际上只能运行某一个虚拟OS
  - Hyper-V：Windows下的虚拟化平台

### Native VMM 原生虚拟机监控器
- 它**直接运行在硬件上，不需要寄宿于另一个OS**
- 它是**对硬件的虚拟**
- 由于直接运行在硬件上，通常它需要内含一个最小OS
- 对硬件的直接虚拟允许设备以不同“形态”运行，比如说有时计算机设备并不充当通用计算机，而是承担类似网络交换机这样的专用计算任务，此时可以借助Native VMM

## 分布式客户机/服务机通信（待完善）
### 客户端
### 服务端
- 迭代服务器
- 并发服务器

### 带外通信

带内数据是指应用程序之间的业务通信数据。（参见TCP连接的字节流）

带外数据则是通常字节流之外的额外通信。

## 服务器与状态
- 无状态服务器
- 有状态服务器

### 无状态服务器
特点：
- 不记录某一文件是否被打开
- 不保证客户缓存状态
- **不追踪客户端状态**

效果：
- 服务器与客户端完全独立：更可靠，易于调试
- 由于客户端/服务端的宕机导致的不一致减少了
- 由于服务器无状态，可能带来性能下降

### 有状态服务器
特点：
- 记录客户端信息
- 可以预读取
- 利用缓存提高性能

效果：
- 性能非常高
- 可靠性存在问题

## 服务器集群
- 服务器网关
  - 分发请求
  - 负载均衡
  - 可能称为整个系统的瓶颈

### 负载均衡方法
- 基于传输层交换的方法：基于机器负载进行分发
- 基于内容感知的方法：根据内容的类别进行分发（典型的是Web资源走CDN，表单走后端）
- 混合

## 广域网服务集群（待完善）
一种常见的实现是基于DNS