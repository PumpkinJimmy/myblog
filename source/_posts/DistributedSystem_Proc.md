---
abbrlink: '0'
date: 2021-09-24 15:02:14
---
# 分布式系统的进程与虚拟化
## 上下文
- 处理器上下文
  - 寄存器
- 线程上下文
  - 处理器上下文
  - TCB
- 进程上下文
  - PCB
    - 处理器上下文
    - 线程上下文
    - 优先级
    - IO信息
    - 内存指针
    - MMU（页表指针）
    - TLB（块表）
    - 记账信息
  - 数据段
  - 代码段
  - 栈

容易发现：
- 进程上下文切换开销较大；线程切换开销较小
- 进程切换通常需要模式切换（使用系统调用）；线程切换不一定要陷入OS
- 线程之间共享地址空间：
  - 一方面，它允许线程之间通过共享变量来通信
  - 另一方面，线程之间共享地址空间可能导致相互干扰，隔离性不如进程

更严重的，线程之间隔离性差的问题可能导致*旁道攻击*

上下文切换的开销：
- 直接的：执行切换所需要的处理器时间
- 间接的：流水线清空，Cache失效、刷新（**实际系统中间接开销才是主要的开销**）

## 线程实现
### 用户级线程
现在的线程功能通常是用户态库提供*用户级线程*（如Pthread）。它的切换开销较小。

### 内核级线程
性能一般，但是可以充分利用多核

### 混合
实际上在内核级线程和用户级线程混合使用才是最优的。




## 分布式客户机/服务机通信（待完善）
### 客户端
### 服务端
- 迭代服务器
- 并发服务器

### 带外通信

带内数据是指应用程序之间的业务通信数据。（参见TCP连接的字节流）

带外数据则是通常字节流之外的额外通信。

## 服务器与状态
- 无状态服务器
- 有状态服务器

### 无状态服务器
特点：
- 不记录某一文件是否被打开
- 不保证客户缓存状态
- **不追踪客户端状态**

效果：
- 服务器与客户端完全独立：更可靠，易于调试
- 由于客户端/服务端的宕机导致的不一致减少了
- 由于服务器无状态，可能带来性能下降

### 有状态服务器
特点：
- 记录客户端信息
- 可以预读取
- 利用缓存提高性能

效果：
- 性能非常高
- 可靠性存在问题

## 服务器集群
- 服务器网关
  - 分发请求
  - 负载均衡
  - 可能称为整个系统的瓶颈

### 负载均衡方法
- 基于传输层交换的方法：基于机器负载进行分发
- 基于内容感知的方法：根据内容的类别进行分发（典型的是Web资源走CDN，表单走后端）
- 混合

## 广域网服务集群（待完善）
一种常见的实现是基于DNS