---
date: 2021-11-18 10:11:52.858619+08:00
title: 智能合约

---
# 智能合约

智能合约是一段代码。其本质是**对状态转移的一致认可**。这里的“状态”是整个以太坊系统看作状态机。


## 合约账户
- 存储了合约代码（机器码），还存储了合约数据
- 不由具体公钥和私钥控制
- 具有地址，可以用于被*调用*（to字段）
- 通常不能*发起*合约。唯一的例外是**合约账号创建合约**
- 账户Nounce通常不变
- 常用的合约代码语言是Solidity，类似JavaScript

## 合约地址
- 由于不对应一对密钥，所以生成方法不同于通常账户（从公钥的哈希生成）
- 两种生成方法：
  - 合约创建者的地址和Nounce
  - 合约创建者的地址、Nounce和代码

## 调用合约
### 如何发起调用
使用如下方法调用合约：
1. 发起一笔交易，使用**合约账户的地址**作为**接收方**
2. 发起者在交易中声明合约函数调用的参数
   
实际实现中，使用“函数名的哈希+参数值”的序列化作为一个具体合约函数调用的表示。

注意，在一次合约调用中，**一旦出现任何异常，整个调用操作会全部回滚**

### 常见调用（待完善）

注意，以下这些操作**都需要花费Gas**
```
call()
callcode()
delegatecall()

balance()
transfer()
send()
```

以下三个操作可以转账（发送ETH）：
```
transfer()
send()
call.value()
```

## 创建合约
步骤：
1. 创建合约账户
2. **发起交易，将代码存储到以太坊合约账户中**

这个过程也称为合约的*部署*

创建合约的交易的说明:
1. `To=0`，即**没有接收地址**
2. 合约代码和初始化数据放在交易的data字段中

## 停机问题与Gas
- 停机问题
  
  **图灵机上，一个程序是否在有限时间内结束，是一个不可判定问题**

- 在区块链上允许运行任何用户代码的智能合约需要保证代码能够停机
- 解决方法：**运行代码中的每个指令都需要消耗Gas**
  - 在调用智能合约时，需要预先支付Gas
  - 运行过程中代码不断消耗预先支付的Gas
  - 若Gas用完了，则代码停机
  - 否则，合约运行完成，返还未用完的Gas
  - 本质上这种停机是承诺“代码在k步内结束”

- Gas的几个量
  - Gas 
  - GasLimit Gas消耗上限
    
    一旦Gas消耗超过GasLimit会终止合约执行、抛出异常并回滚。

  - GasUsed 实际消耗的Gas
  - GasPrice Gas到ETH的汇率

- Gas的弊端
  - 合约操作的Gas定价是开发者（运行代码的矿工组织）决定的

## 异常处理
- 没有`try-catch`异常处理结构，任何错误都会导致异常抛出和回滚
- `call/callcode/delegatecall`中子调用的异常只会回滚子调用，不会让整个合约运行回滚
- 智能合约的原子性：
  
  一次合约调用中，其中所有操作**要么全部生效，要么全部不生效**。这种类似事务的特性对类似资产交换的场景尤为重要。

## EVM（以太坊虚拟机）
考虑：如何运行合约代码？
1. 高层的语言（脚本语言）
   
   由于节点配置不同，难以保证一致性

2. 机器码
   
   这样的程序与特定架构绑定，不适用高度异构的去中心化分布式系统

3. 折中：**虚拟化**
   
   使用虚拟机

以太坊使用虚拟化方案，也就是EVM。

具体来说
- 使用高层语言（如Solidity）编写源代码
- 将代码编译成EVM字节码存储和运行

## 智能合约的缺陷与攻击（待完善）

重入攻击（区别重放攻击）

一旦代码不完善，可能导致：
1. 钱永远锁在合约账户中取不出来
2. 遭遇重入攻击，导致金钱损失
3. 合约代码一经发布后不可篡改
4. 在区块链系统中，**智能合约的代码是法律**。但即便宪法都是可以修改的，但合约却永远不能修改。